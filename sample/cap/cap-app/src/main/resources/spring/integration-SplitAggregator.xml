<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:int="http://www.springframework.org/schema/integration"
    xmlns:int-http="http://www.springframework.org/schema/integration/http" xmlns:int-ip="http://www.springframework.org/schema/integration/ip"
    xmlns:stream="http://www.springframework.org/schema/integration/stream" xmlns:ws="http://www.springframework.org/schema/integration/ws"
    xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
		http://www.springframework.org/schema/integration/ip http://www.springframework.org/schema/integration/ip/spring-integration-ip.xsd
		http://www.springframework.org/schema/integration/http http://www.springframework.org/schema/integration/http/spring-integration-http.xsd
		http://www.springframework.org/schema/integration http://www.springframework.org/schema/integration/spring-integration.xsd
        http://www.springframework.org/schema/integration/stream
            http://www.springframework.org/schema/integration/stream/spring-integration-stream.xsd
		http://www.springframework.org/schema/integration/ws http://www.springframework.org/schema/integration/ws/spring-integration-ws.xsd">

    <int:channel id="balanceInquirySplitAggregatorChannel" />

    <int-http:inbound-gateway id="inboundInquiryControllerSplitAggregator" request-timeout="1000" reply-timeout="1000" request-channel="balanceInquirySplitAggregatorChannel"
        error-channel="failedChannel" supported-methods="POST" path="/balanceInquirySplitAggregator" request-payload-type="com.iisigroup.gw.app.domain.BalanceInquiryRequest"
        reply-channel="balanceOutChannel">

        <int-http:request-mapping consumes="application/json" produces="application/json" />
    </int-http:inbound-gateway>

    <int:channel id="inputSplitAggregator" />
    <int:channel id="input2SplitAggregator" />
    <int:channel id="input3SplitAggregator" />
    <int:channel id="bytes2stringSplitAggregator" />
    <int:channel id="xmlToJSONChannelSplitAggregator" />

    <int:service-activator ref="enmInquiryEndpoint" method="balanceInquiry" input-channel="balanceInquirySplitAggregatorChannel" output-channel="inputSplitAggregator" />
    <int:service-activator ref="balanceInquiryJson2Object" method="doTransform" input-channel="inputSplitAggregator" output-channel="splitInputChannel" />
    <int:transformer ref="clientHex2StringTransformerHandler" input-channel="bytes2stringSplitAggregator" output-channel="xmlToJSONChannelSplitAggregator" />
    <int:transformer id="xmlToJSONTransformerSplitAggregator" ref="balanceInquiryXmlToJSONTransformer" input-channel="xmlToJSONChannelSplitAggregator" output-channel="balanceInChannel" />

    <int-ip:tcp-connection-factory id="clientSplitAggregator" type="client" host="localhost" port="5566" single-use="true" so-timeout="100000" />

    <int-ip:tcp-outbound-gateway request-channel="input3SplitAggregator" reply-channel="bytes2stringSplitAggregator" connection-factory="clientSplitAggregator" request-timeout="100000"
        reply-timeout="100000">
        <int-ip:request-handler-advice-chain>
            <ref bean="retryAdvice" />
            <!-- <ref bean="circuitBreakerAdvice" /> -->
        </int-ip:request-handler-advice-chain>
    </int-ip:tcp-outbound-gateway>

    <int:channel id="splitInputChannel" datatype="com.iisigroup.socket.app.model.BalanceInquiryBean" />
    
    <int:splitter ref="splitterEndpoint" method="split" input-channel="splitInputChannel" output-channel="input2SplitAggregator" />

    <int:transformer ref="balanceInquiryTransformer" input-channel="input2SplitAggregator" output-channel="input3SplitAggregator" />

    <int:channel id="balanceInChannel">
        <int:queue />
    </int:channel>
    <int:channel id="aggrOutChannel">
        <int:queue />
    </int:channel>
    <int:channel id="balanceOutChannel">
        <!-- <int:queue /> -->
    </int:channel>

    <int:aggregator id="balanceAggregator" input-channel="balanceInChannel" output-channel="aggrOutChannel" correlation-strategy-expression="payload.balance"
        release-strategy-expression="size() ==2" expire-groups-upon-timeout="true" expire-groups-upon-completion="true" />
    <int:service-activator input-channel="aggrOutChannel" ref="aggregatorEndpoint" method="processBalance" output-channel="balanceOutChannel" />
    <int:poller id="poller" default="true" fixed-delay="1000" />
</beans>